<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>YSM - Full App (KYC, Admin, Tiered Videos)</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <style>
    :root{
      --primary:#E50914; --dark:#000; --glass: rgba(255,255,255,0.04);
      --muted:#9aa; --white:#fff;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,Segoe UI,Arial;background:var(--dark);color:var(--white)}
    header{position:fixed;left:0;right:0;top:0;background:rgba(0,0,0,0.6);padding:14px;border-bottom:1px solid rgba(255,255,255,0.04);z-index:100}
    .header-inner{max-width:1100px;margin:0 auto;display:flex;justify-content:space-between;align-items:center}
    .logo{font-weight:700;color:var(--primary);font-size:20px}
    .btn{padding:10px 14px;border-radius:8px;border:none;cursor:pointer}
    .btn-primary{background:linear-gradient(135deg,var(--primary),#b80710);color:#fff}
    .btn-outline{background:transparent;border:1px solid #333;color:#fff}
    .container{max-width:1100px;margin:86px auto 60px;padding:0 18px}
    .card{background:var(--glass);padding:20px;border-radius:12px;margin-bottom:18px}
    .form-control{width:100%;padding:10px;border-radius:8px;background:transparent;border:1px solid #333;color:#fff;margin-bottom:10px}
    .file-upload{border:2px dashed #333;padding:14px;border-radius:8px;text-align:center;cursor:pointer;margin-bottom:10px}
    .file-name{color:var(--muted);font-size:0.9rem;margin-top:8px}
    .small{font-size:0.9rem;color:var(--muted)}
    .hidden{display:none}
    .badge{padding:6px 10px;border-radius:999px;font-weight:700}
    .badge-pending{background:#ffa500;color:#000}
    .badge-approved{background:#00ff88;color:#000}
    .video-embed{width:100%;height:420px;border:0;border-radius:8px}
    footer{padding:24px;text-align:center;color:var(--muted)}
    .admin-only{border-left:4px solid rgba(229,9,20,0.18);padding-left:12px}
    .row{display:flex;gap:12px}
    .col{flex:1}
    .muted{color:var(--muted)}
    .danger{color:#ff7b7b}
    .success{color:#7bffb3}
    pre{white-space:pre-wrap;word-break:break-word}
  </style>
</head>
<body>
<header>
  <div class="header-inner">
    <div class="logo"><i class="fab fa-youtube"></i> YSM</div>
    <div>
      <button class="btn btn-outline" id="btn-login" onclick="show('login')">Login</button>
      <button class="btn btn-primary" id="btn-join" onclick="show('register')">Join</button>
    </div>
  </div>
</header>

<div class="container">
  <div id="msgs"></div>

  <!-- HOME -->
  <div id="home" class="card">
    <h2>Welcome to YSM</h2>
    <p class="small">Upload YouTube links (admin) → users watch according to tier after KYC approval.</p>
    <div style="margin-top:12px">
      <button class="btn btn-primary" onclick="show('register')">Create Account</button>
      <button class="btn btn-outline" onclick="show('login')">Login</button>
    </div>
  </div>

  <!-- REGISTER -->
  <div id="register" class="card hidden">
    <h3>Create account</h3>
    <input id="reg-name" class="form-control" placeholder="Full name"/>
    <input id="reg-email" class="form-control" placeholder="Email"/>
    <input id="reg-password" class="form-control" placeholder="Password" type="password"/>
    <button class="btn btn-primary" onclick="registerUser()">Create account & send verification</button>
    <p class="small">You will receive a verification email. Verify before submitting KYC.</p>
    <p class="small"><a href="#" onclick="show('home')">← Back</a></p>
  </div>

  <!-- LOGIN -->
  <div id="login" class="card hidden">
    <h3>Login</h3>
    <input id="login-email" class="form-control" placeholder="Email"/>
    <input id="login-password" class="form-control" placeholder="Password" type="password"/>
    <button class="btn btn-primary" onclick="loginUser()">Login</button>
    <p class="small"><a href="#" onclick="show('home')">← Back</a></p>
  </div>

  <!-- KYC -->
  <div id="kyc" class="card hidden">
    <h3>KYC Verification (Required)</h3>
    <p class="small">Please verify your email first. Upload all 4 files.</p>
    <input id="kyc-name" class="form-control" placeholder="Full name (as on ID)"/>
    <select id="kyc-id-type" class="form-control">
      <option value="">Select ID type</option>
      <option value="passport">Passport</option>
      <option value="national_id">National ID</option>
      <option value="driving_license">Driving License</option>
    </select>
    <input id="kyc-id-number" class="form-control" placeholder="ID number"/>
    <div class="file-upload" onclick="$('#kyc-front').click()">Upload ID Front
      <div id="front-file-name" class="file-name">No file chosen</div>
      <input id="kyc-front" type="file" accept="image/*" class="hidden"/>
    </div>
    <div class="file-upload" onclick="$('#kyc-back').click()">Upload ID Back
      <div id="back-file-name" class="file-name">No file chosen</div>
      <input id="kyc-back" type="file" accept="image/*" class="hidden"/>
    </div>
    <div class="file-upload" onclick="$('#kyc-selfie').click()">Upload Selfie with ID
      <div id="selfie-file-name" class="file-name">No file chosen</div>
      <input id="kyc-selfie" type="file" accept="image/*" class="hidden"/>
    </div>
    <div class="file-upload" onclick="$('#kyc-address').click()">Upload Proof of Address
      <div id="address-file-name" class="file-name">No file chosen</div>
      <input id="kyc-address" type="file" accept="image/*" class="hidden"/>
    </div>
    <button class="btn btn-primary" onclick="submitKYC()">Submit KYC</button>
  </div>

  <!-- KYC pending -->
  <div id="kyc-pending" class="card hidden">
    <h3>KYC Pending</h3>
    <p>Your documents are under review by admin. You will be notified once reviewed.</p>
    <div class="badge badge-pending">Under review</div>
  </div>

  <!-- USER DASHBOARD -->
  <div id="user-dashboard" class="card hidden">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div><h3 id="user-name">User</h3><div class="small">Tier: <span id="user-tier">0</span> • KYC: <span id="user-kyc">UNSUBMITTED</span></div></div>
      <div><button class="btn btn-outline" onclick="logout()">Logout</button></div>
    </div>
    <hr/>
    <h4>Available Videos</h4>
    <div class="small">You can watch up to <span id="user-limit">0</span> videos today. Watched: <span id="user-watched">0</span></div>
    <div id="video-list" style="margin-top:12px">Loading videos...</div>
  </div>

  <!-- ADMIN DASHBOARD -->
  <div id="admin-dashboard" class="card hidden admin-only">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3>Admin Panel</h3>
      <div><button class="btn btn-outline" onclick="logout()">Logout</button></div>
    </div>

    <div style="margin-top:12px;display:flex;gap:8px">
      <button class="btn btn-primary" onclick="loadKYCRequests()">KYC Management</button>
      <button class="btn btn-outline" onclick="showAddVideo()">Add Video</button>
      <button class="btn btn-outline" onclick="loadUsers()">Users</button>
      <button class="btn btn-outline" onclick="showSettings()">Settings</button>
    </div>

    <div id="admin-content" style="margin-top:12px">Select a panel above.</div>

    <!-- Add Video -->
    <div id="add-video" class="hidden" style="margin-top:12px">
      <h4>Add Video</h4>
      <input id="video-title" class="form-control" placeholder="Title"/>
      <input id="video-url" class="form-control" placeholder="YouTube link or id"/>
      <input id="video-tier" class="form-control" type="number" placeholder="Tier level (e.g. 1)"/>
      <input id="video-amount" class="form-control" type="number" placeholder="Amount per view (e.g. 0.10)" step="0.01"/>
      <button class="btn btn-primary" onclick="addVideo()">Add</button>
      <button class="btn btn-outline" onclick="hideAddVideo()">Cancel</button>
    </div>
  </div>

  <!-- Settings modal placeholder -->
  <div id="settings" class="card hidden">
    <h4>Global Tier Settings</h4>
    <div class="small">Tiers define daily video limits and per-video amounts (admin can edit).</div>
    <pre id="tiers-pre" style="background:#0b0b0b;padding:12px;border-radius:8px"></pre>
  </div>

</div>

<footer>&copy; 2025 YSM</footer>

<!-- Firebase SDKs (compat for simplicity) -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>

<script>
/* ========================= YOUR FIREBASE CONFIG (from you) ========================= */
const firebaseConfig = {
  apiKey: "AIzaSyDOKJQayF5j5xCp6LVZEEFFJH0QiQtezgg",
  authDomain: "sm-platform-6ef20.firebaseapp.com",
  projectId: "sm-platform-6ef20",
  storageBucket: "sm-platform-6ef20.firebasestorage.app",
  messagingSenderId: "485407332553",
  appId: "1:485407332553:web:77bd1bf2b3146486e51518"
};
/* ================================================================================ */

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

function $(id){ return document.getElementById(id); }
function show(id){
  document.querySelectorAll('#home,#register,#login,#kyc,#kyc-pending,#user-dashboard,#admin-dashboard,#add-video,#settings').forEach(el=>el.classList.add('hidden'));
  if(id==='register') $('register').classList.remove('hidden');
  if(id==='login') $('login').classList.remove('hidden');
  if(id==='home') $('home').classList.remove('hidden');
  if(id==='kyc') $('kyc').classList.remove('hidden');
  if(id==='kyc-pending') $('kyc-pending').classList.remove('hidden');
  if(id==='user-dashboard') $('user-dashboard').classList.remove('hidden');
  if(id==='admin-dashboard') $('admin-dashboard').classList.remove('hidden');
  if(id==='add-video') $('add-video').classList.remove('hidden');
  if(id==='settings') $('settings').classList.remove('hidden');
  window.scrollTo(0,0);
}
function showMessage(msg, type='info'){ const d=document.createElement('div'); d.textContent=msg; d.style.padding='10px'; d.style.margin='8px 0'; d.style.border='1px solid rgba(255,255,255,0.04)'; $('msgs').appendChild(d); setTimeout(()=>d.remove(),6000); }

/* ---------------------------- app state ---------------------------- */
let currentUser = null;
let currentUserDoc = null;
let isAdmin = false;
let tierConfig = null; // loaded from Firestore or default

/* ---------- default tier config (used if Firestore has none) ---------- */
const DEFAULT_TIERS = {
  "1": { name: "Tier 1", dailyLimit: 8, defaultAmount: 0.10 },
  "2": { name: "Tier 2", dailyLimit: 10, defaultAmount: 0.25 },
  "3": { name: "Tier 3", dailyLimit: 15, defaultAmount: 0.50 },
  "4": { name: "VIP",   dailyLimit: 20, defaultAmount: 1.00 }
};

/* ---------------- file input labels ---------------- */
(function attachFileLabels(){
  const map = { 'kyc-front':'front-file-name', 'kyc-back':'back-file-name', 'kyc-selfie':'selfie-file-name', 'kyc-address':'address-file-name' };
  Object.keys(map).forEach(id=>{
    const inp = $(id), label = $(map[id]);
    if(inp) inp.addEventListener('change', e=>{ const f=e.target.files && e.target.files[0]; if(f) label.textContent = f.name; });
  });
})();

/* ---------------- auth listener ---------------- */
auth.onAuthStateChanged(async user=>{
  try{
    currentUser = user;
    if(!user){
      // signed out
      isAdmin=false; currentUserDoc=null;
      show('home'); return;
    }
    await user.reload();
    // ensure user doc
    const userRef = db.collection('users').doc(user.uid);
    const s = await userRef.get();
    if(!s.exists){
      await userRef.set({ name: user.displayName || '', email: user.email || '', createdAt: firebase.firestore.FieldValue.serverTimestamp(), kycStatus: 'unsubmitted', tierLevel: 0 }, {merge:true});
    }
    const d = (await userRef.get()).data();
    currentUserDoc = d || {};
    // admin check (custom claim)
    try{ const token = await user.getIdTokenResult(true); isAdmin = !!(token && token.claims && token.claims.admin); } catch(e){ isAdmin=false; }
    // load tier config
    await loadTierConfig();
    // Email verification check
    if(!user.emailVerified){
      showMessage('Please verify your email before submitting KYC. Check your inbox.'); show('home'); return;
    }
    // KYC status routing
    const k = (currentUserDoc && currentUserDoc.kycStatus) || 'unsubmitted';
    if(k === 'approved'){
      show('user-dashboard'); renderUserDashboard();
      if(isAdmin) show('admin-dashboard');
    } else if(k === 'pending'){
      show('kyc-pending');
    } else {
      show('kyc');
    }
  }catch(err){
    console.error('auth onChange error', err);
    showMessage('Error loading user data: ' + (err.message || err));
    show('home');
  }
});

/* ------------------- register / login / logout ------------------- */
async function registerUser(){
  const name = $('reg-name').value.trim();
  const email = $('reg-email').value.trim();
  const password = $('reg-password').value;
  if(!name || !email || !password) return showMessage('Fill name, email, password.');
  try{
    const cred = await auth.createUserWithEmailAndPassword(email, password);
    await cred.user.sendEmailVerification({ url: window.location.origin + '/', handleCodeInApp: true });
    await db.collection('users').doc(cred.user.uid).set({ name, email, kycStatus:'unsubmitted', tierLevel:0, createdAt: firebase.firestore.FieldValue.serverTimestamp() }, {merge:true});
    showMessage('Account created. Verification email sent.');
    show('home');
  }catch(err){ console.error(err); showMessage(err.message || err); }
}

async function loginUser(){
  const email = $('login-email').value.trim();
  const password = $('login-password').value;
  if(!email || !password) return showMessage('Enter credentials.');
  try{ await auth.signInWithEmailAndPassword(email, password); showMessage('Logged in'); }
  catch(err){ console.error(err); showMessage(err.message || err); }
}

function logout(){ auth.signOut(); showMessage('Logged out'); show('home'); }

/* ------------------- KYC submission to Firebase Storage ------------------- */
async function submitKYC(){
  if(!currentUser) return showMessage('Login first.');
  await currentUser.reload();
  if(!currentUser.emailVerified) return showMessage('Verify your email before KYC.');
  const name = $('kyc-name').value.trim();
  const idType = $('kyc-id-type').value;
  const idNumber = $('kyc-id-number').value.trim();
  const files = {
    front: $('kyc-front').files && $('kyc-front').files[0],
    back: $('kyc-back').files && $('kyc-back').files[0],
    selfie: $('kyc-selfie').files && $('kyc-selfie').files[0],
    address: $('kyc-address').files && $('kyc-address').files[0]
  };
  if(!name || !idType || !idNumber) return showMessage('Fill KYC fields.');
  for(const k of Object.keys(files)) if(!files[k]) return showMessage('Upload ' + k);
  try{
    showMessage('Uploading files...');
    const urls = {};
    for(const key of Object.keys(files)){
      const f = files[key];
      const safe = f.name.replace(/[^a-zA-Z0-9.\-_]/g,'_');
      const path = `kyc/${currentUser.uid}/${Date.now()}_${key}_${safe}`;
      const ref = storage.ref().child(path);
      const snap = await ref.put(f);
      const url = await snap.ref.getDownloadURL();
      urls[key] = url;
    }
    const payload = { name, idType, idNumber, files: urls, status:'pending', submittedAt: firebase.firestore.FieldValue.serverTimestamp(), userId: currentUser.uid, email: currentUser.email };
    await db.collection('kyc_submissions').doc(currentUser.uid).set(payload, {merge:true});
    await db.collection('users').doc(currentUser.uid).set({ kycStatus:'pending', kycSubmittedAt: firebase.firestore.FieldValue.serverTimestamp() }, {merge:true});
    showMessage('KYC submitted. Admin will review.');
    show('kyc-pending');
  }catch(err){ console.error('KYC error', err); showMessage('KYC upload failed: ' + (err.message || err)); }
}

/* ------------------- Admin: load pending KYC ------------------- */
async function loadKYCRequests(){
  if(!isAdmin) return showMessage('Admin only');
  const c = $('admin-content'); c.innerHTML = '<h4>Pending KYC</h4><div>Loading...</div>';
  try{
    const snap = await db.collection('kyc_submissions').where('status','==','pending').get();
    if(snap.empty){ c.innerHTML = '<div>No pending KYC.</div>'; return; }
    c.innerHTML = '';
    snap.forEach(doc=>{
      const d = doc.data();
      const el = document.createElement('div');
      el.style.padding='10px'; el.style.borderBottom='1px solid #222';
      el.innerHTML = `<strong>${d.email}</strong> — ${d.name} <div class="small">Submitted: ${d.submittedAt ? new Date(d.submittedAt.toDate()).toLocaleString() : '—'}</div>
        <div style="margin-top:8px">
          <button class="btn btn-primary" onclick="approveKYC('${doc.id}')">Approve</button>
          <button class="btn btn-outline" onclick="rejectKYC('${doc.id}')">Reject</button>
          <button class="btn btn-outline" onclick="viewKYC('${doc.id}')">View files</button>
        </div>`;
      c.appendChild(el);
    });
  }catch(err){ console.error(err); c.innerHTML = '<div>Error loading KYC</div>'; }
}

async function viewKYC(id){
  try{
    const doc = await db.collection('kyc_submissions').doc(id).get();
    if(!doc.exists) return showMessage('Not found');
    const d = doc.data();
    const win = window.open('', '_blank');
    win.document.write(`<h2>KYC for ${d.email}</h2>`);
    Object.keys(d.files||{}).forEach(k=> win.document.write(`<div>${k}: <a href="${d.files[k]}" target="_blank">Open</a></div>`));
  }catch(err){ console.error(err); showMessage('Failed to view'); }
}

async function approveKYC(id){
  if(!isAdmin) return showMessage('Admin only');
  const tier = prompt('Assign tier number (eg 1):', '1');
  if(tier === null) return;
  try{
    await db.collection('kyc_submissions').doc(id).update({ status:'approved', reviewedAt: firebase.firestore.FieldValue.serverTimestamp(), reviewedBy: auth.currentUser ? auth.currentUser.uid : 'admin' });
    await db.collection('users').doc(id).set({ kycStatus:'approved', kycApprovedAt: firebase.firestore.FieldValue.serverTimestamp(), tierLevel: Number(tier)||1 }, {merge:true});
    showMessage('Approved and assigned tier ' + tier);
    loadKYCRequests();
  }catch(err){ console.error(err); showMessage('Approve failed'); }
}

async function rejectKYC(id){
  if(!isAdmin) return showMessage('Admin only');
  const reason = prompt('Reason for rejection (optional)');
  try{
    await db.collection('kyc_submissions').doc(id).update({ status:'rejected', reviewedAt: firebase.firestore.FieldValue.serverTimestamp(), rejectionReason: reason || '' });
    await db.collection('users').doc(id).set({ kycStatus:'rejected' }, {merge:true});
    showMessage('Rejected');
    loadKYCRequests();
  }catch(err){ console.error(err); showMessage('Reject failed'); }
}

/* ------------------- Admin: Add video ------------------- */
function showAddVideo(){ if(!isAdmin) return showMessage('Admin only'); $('add-video').classList.remove('hidden'); $('admin-content').classList.add('hidden'); }
function hideAddVideo(){ $('add-video').classList.add('hidden'); $('admin-content').classList.remove('hidden'); }

function extractYouTubeId(v){
  if(!v) return '';
  if(!v.includes('/')) return v;
  try{
    const u = new URL(v);
    if(u.hostname.includes('youtu.be')) return u.pathname.slice(1);
    if(u.hostname.includes('youtube.com')) {
      const p = u.searchParams.get('v'); if(p) return p;
      if(u.pathname.includes('/embed/')) return u.pathname.split('/embed/')[1];
    }
  }catch(e){}
  return v.split('/').pop();
}

async function addVideo(){
  if(!isAdmin) return showMessage('Admin only');
  const title = $('video-title').value.trim();
  const url = $('video-url').value.trim();
  const tier = Number($('video-tier').value) || 1;
  const amount = Number($('video-amount').value) || (tierConfig && tierConfig[tier] ? tierConfig[tier].defaultAmount : 0.1);
  if(!title || !url) return showMessage('Provide title and URL.');
  const vid = extractYouTubeId(url);
  try{
    await db.collection('videos').add({ title, videoId: vid, tierLevel: tier, amount: amount, active:true, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
    showMessage('Video added');
    $('video-title').value=''; $('video-url').value=''; $('video-tier').value=''; $('video-amount').value='';
    hideAddVideo();
  }catch(err){ console.error(err); showMessage('Add video failed'); }
}

/* ------------------- Load videos for user (respect tier & daily limits) ------------------- */
async function loadVideosForUser(){
  const list = $('video-list'); list.innerHTML = 'Loading...';
  try{
    const userTier = (currentUserDoc && currentUserDoc.tierLevel) || 0;
    const q = await db.collection('videos').where('active','==',true).orderBy('createdAt','desc').get();
    const vids = [];
    q.forEach(d=>{ const data=d.data(); if((data.tierLevel||0) <= userTier) vids.push({id:d.id,...data}); });
    if(vids.length===0){ list.innerHTML = '<div>No videos available for your tier.</div>'; updateWatchUI(0,0); return; }
    // show watch limit
    const limit = getDailyLimitForTier(userTier);
    const watchedToday = await getWatchedCountToday(currentUser.uid);
    updateWatchUI(limit, watchedToday);
    list.innerHTML = '';
    vids.forEach(v=>{
      const el = document.createElement('div'); el.style.marginBottom='18px';
      el.innerHTML = `<h4 style="margin-bottom:8px">${v.title} <span class="small muted">[Tier ${v.tierLevel}]</span></h4>
        <div style="position:relative;padding-top:56.25%"><iframe class="video-embed" src="https://www.youtube.com/embed/${v.videoId}?rel=0&modestbranding=1" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen style="position:absolute;left:0;top:0;width:100%;height:100%"></iframe></div>
        <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
          <div class="small">Earn: $${Number(v.amount||0).toFixed(2)} per view</div>
          <button class="btn btn-primary" onclick="attemptWatch('${v.id}', ${v.tierLevel}, ${Number(v.amount||0)})">Mark Watched & Earn</button>
        </div>`;
      list.appendChild(el);
    });
  }catch(err){ console.error(err); list.innerHTML = '<div>Error loading videos</div>'; }
}

/* ------------------- Watch tracking + limits ------------------- */
function getDateKey(dateObj=new Date()){
  return dateObj.toISOString().slice(0,10); // YYYY-MM-DD
}
function getDailyLimitForTier(tier){
  if(!tierConfig) return DEFAULT_TIERS[tier] ? DEFAULT_TIERS[tier].dailyLimit : 0;
  return (tierConfig[tier] && tierConfig[tier].dailyLimit) ? tierConfig[tier].dailyLimit : (DEFAULT_TIERS[tier] ? DEFAULT_TIERS[tier].dailyLimit : 0);
}
async function getWatchedCountToday(uid){
  if(!uid) return 0;
  const key = getDateKey();
  const doc = await db.collection('users').doc(uid).collection('watchStats').doc(key).get();
  if(!doc.exists) return 0;
  const data = doc.data(); return data.count || 0;
}
async function updateWatchUI(limit, watched){
  if($('user-limit')) $('user-limit').textContent = limit;
  if($('user-watched')) $('user-watched').textContent = watched;
}
async function attemptWatch(videoDocId, videoTier, amount){
  if(!currentUser) return showMessage('Login to watch.');
  if(!currentUserDoc) return showMessage('User data not loaded.');
  const userTier = currentUserDoc.tierLevel || 0;
  if((videoTier||0) > userTier) return showMessage('This video is above your tier level.');
  // check counts
  const limit = getDailyLimitForTier(userTier);
  const key = getDateKey();
  const userWatchRef = db.collection('users').doc(currentUser.uid).collection('watchStats').doc(key);
  const watchedToday = await getWatchedCountToday(currentUser.uid);
  if(watchedToday >= limit) return showMessage('Daily watch limit reached.');
  // check if this specific video was already watched today (prevent double-earning)
  const alreadySnap = await userWatchRef.collection('videos').doc(videoDocId).get();
  if(alreadySnap.exists) return showMessage('You already watched this video today.');
  // record the watch (transactional)
  try{
    await db.runTransaction(async tx=>{
      const wDoc = await tx.get(userWatchRef);
      if(!wDoc.exists) tx.set(userWatchRef, { count: 1 }, { merge:true });
      else {
        const prev = wDoc.data().count || 0;
        if(prev >= limit) throw new Error('limit reached');
        tx.update(userWatchRef, { count: prev+1 });
      }
      tx.set(userWatchRef.collection('videos').doc(videoDocId), { watchedAt: firebase.firestore.FieldValue.serverTimestamp(), amount: amount }, {merge:true});
      // credit user's wallet/account (simple balance field)
      const userRef = db.collection('users').doc(currentUser.uid);
      tx.set(userRef, { balance: firebase.firestore.FieldValue.increment(amount), lastEarnAt: firebase.firestore.FieldValue.serverTimestamp() }, {merge:true});
      // track earning in earnings collection (optional)
      const earnRef = db.collection('earnings').doc();
      tx.set(earnRef, { userId: currentUser.uid, videoId: videoDocId, amount: amount, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
    });
    showMessage('Watch recorded. You earned $' + Number(amount).toFixed(2));
    // refresh UI
    const newCount = await getWatchedCountToday(currentUser.uid);
    updateWatchUI(limit, newCount);
  }catch(err){
    console.error('watch tx failed', err);
    showMessage('Failed to record watch: ' + (err.message || err));
  }
}

/* ------------------- Load tier config (from Firestore config/globalSettings) ------------------- */
async function loadTierConfig(){
  try{
    const cfgDoc = await db.collection('config').doc('tiers').get();
    if(cfgDoc.exists){ tierConfig = cfgDoc.data().tiers || DEFAULT_TIERS; }
    else { tierConfig = DEFAULT_TIERS; }
    // show in settings area
    $('tiers-pre').textContent = JSON.stringify(tierConfig, null, 2);
  }catch(err){ console.warn('loadTierConfig', err); tierConfig = DEFAULT_TIERS; $('tiers-pre').textContent = JSON.stringify(tierConfig, null, 2); }
}

/* ------------------- Admin: load users ------------------- */
async function loadUsers(){
  if(!isAdmin) return showMessage('Admin only');
  const c = $('admin-content'); c.innerHTML = '<h4>Users</h4><div>Loading...</div>';
  try{
    const snap = await db.collection('users').get();
    c.innerHTML = '';
    snap.forEach(doc=>{
      const d = doc.data();
      const el = document.createElement('div'); el.style.padding='8px'; el.style.borderBottom='1px solid #222';
      el.innerHTML = `<strong>${d.email}</strong> — Tier: ${d.tierLevel||0} — KYC: ${d.kycStatus||'unsubmitted'}
        <div style="margin-top:8px">
          <button class="btn btn-outline" onclick="viewUser('${doc.id}')">View</button>
        </div>`;
      c.appendChild(el);
    });
  }catch(err){ console.error(err); c.innerHTML = '<div>Error loading users</div>'; }
}
function viewUser(uid){ window.open('/console?uid='+uid,'_blank'); showMessage('Open admin console to manage user: ' + uid); }

/* ------------------- Settings UI ------------------- */
function showSettings(){ if(!isAdmin) return showMessage('Admin only'); $('settings').classList.remove('hidden'); $('admin-content').classList.add('hidden'); $('tiers-pre').textContent = JSON.stringify(tierConfig, null, 2); }

/* ------------------- helper render user dashboard ------------------- */
async function renderUserDashboard(){
  if(!currentUser || !currentUserDoc) return;
  $('user-name').textContent = currentUserDoc.name || currentUser.email;
  $('user-tier').textContent = currentUserDoc.tierLevel || 0;
  $('user-kyc').textContent = currentUserDoc.kycStatus || 'unsubmitted';
  await loadVideosForUser();
}

/* ------------------- utilities ------------------- */
function safe(v){ return v || ''; }
function log(e){ console.log(e); }

/* ------------------- exports for onclick ------------------- */
window.$ = (id)=>document.getElementById(id);
window.show = show;
window.registerUser = registerUser;
window.loginUser = loginUser;
window.logout = logout;
window.submitKYC = submitKYC;
window.loadKYCRequests = loadKYCRequests;
window.approveKYC = approveKYC;
window.rejectKYC = rejectKYC;
window.viewKYC = viewKYC;
window.showAddVideo = showAddVideo;
window.hideAddVideo = hideAddVideo;
window.addVideo = addVideo;
window.loadVideosForUser = loadVideosForUser;
window.loadUsers = loadUsers;
window.showSettings = showSettings;

/* ------------------- initial page ------------------- */
show('home');
</script>
</body>
</html>
