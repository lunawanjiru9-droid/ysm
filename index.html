<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>YSM - YouTube Subs Monetization (Final)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --red:#FF0000; --bg-dark-1:#000000; --bg-dark-2:#111111; --muted:#9aa0a6; --card: rgba(255,255,255,0.03); color-scheme: dark; }
    html,body{height:100%;margin:0;font-family:Inter,Segoe UI,system-ui,Arial;background:linear-gradient(180deg,var(--bg-dark-1),var(--bg-dark-2));color:#fff}
    .container{max-width:1100px;margin:0 auto;padding:20px}
    header{display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid rgba(255,255,255,0.04)}
    .logo{font-weight:700;color:var(--red);display:flex;gap:10px;align-items:center}
    .btn{padding:8px 12px;border-radius:10px;border:0;cursor:pointer;font-weight:600}
    .btn-outline{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#fff}
    .btn-primary{background:linear-gradient(90deg,var(--red),#b80710);color:#fff}
    .hero{padding:60px 0;text-align:center}
    .grid{display:grid;gap:16px}
    .card{background:var(--card);padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.04)}
    .form-control{width:100%;padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#fff}
    .file-upload{padding:12px;border-radius:8px;border:1px dashed rgba(255,255,255,0.06);text-align:center;cursor:pointer}
    footer{padding:30px 0;text-align:center;border-top:1px solid rgba(255,255,255,0.04);margin-top:40px;color:var(--muted)}
    .hidden{display:none}
    .two-col{display:grid;grid-template-columns:1fr 360px;gap:20px}
    .small{font-size:13px;color:var(--muted)}
    /* Loader styles */
    #loader-wrap{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;background:#fff;z-index:9999;transition:opacity 1.5s ease}
    .play-icon{width:96px;height:96px;background:transparent;display:flex;align-items:center;justify-content:center}
    .play-icon svg{width:64px;height:64px;fill:var(--red)}
    .loader-bar{width:240px;height:6px;background:rgba(0,0,0,0.08);border-radius:6px;margin-top:18px;overflow:hidden;position:relative}
    .loader-progress{position:absolute;left:50%;right:50%;height:100%;background:var(--red);transform-origin:center;transition:width 0.2s linear,left 0.2s linear,right 0.2s linear}
    /* Fade transitions for pages */
    .page {opacity:1;transition:opacity 1s ease}
    .page.hidden {opacity:0;pointer-events:none}
    /* Simple responsive */
    @media (max-width:800px){.two-col{grid-template-columns:1fr}}
  </style>

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-storage-compat.js"></script>
</head>
<body>
  <!-- Loader (shows on every refresh) -->
  <div id="loader-wrap">
    <div class="play-icon" aria-hidden="true">
      <!-- Static 2D Play icon -->
      <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <path d="M3 22V2l18 10L3 22z"></path>
      </svg>
    </div>
    <div class="loader-bar" aria-hidden="true">
      <div id="loader-progress" class="loader-progress" style="left:50%;right:50%;width:0%"></div>
    </div>
  </div>

  <!-- App container -->
  <div class="container" id="app-root" style="opacity:0;transition:opacity 1s ease">
    <header>
      <div class="logo" style="font-size:18px">YSM</div>
      <div>
        <a class="small nav-link" href="#" onclick="showPage('landing-page')">Home</a>
        <button class="btn btn-outline" id="btn-login" onclick="showPage('login-page')">Login</button>
        <button class="btn btn-primary" id="btn-register" onclick="showPage('register-page')">Join YSM</button>
      </div>
    </header>

    <main style="padding:20px">
      <!-- Landing -->
      <section id="landing-page" class="page">
        <div class="hero">
          <h1 style="font-size:28px">üåç Welcome to YSM ‚Äî Where Attention Becomes Wealth</h1>
          <p class="small" style="max-width:800px;margin:10px auto">Watch sponsored videos, complete tasks, and earn. Secure KYC & admin-managed tiers.</p>
          <div style="margin-top:18px">
            <button class="btn btn-primary" onclick="showPage('register-page')">Get Started</button>
            <button class="btn btn-outline" onclick="showPage('login-page')">Sign In</button>
          </div>
        </div>
      </section>

      <!-- Register -->
      <section id="register-page" class="page hidden">
        <div class="card" style="max-width:720px;margin:auto">
          <h2>Create Account</h2>
          <div style="margin-top:10px"><input id="reg-name" class="form-control" placeholder="Full name"></div>
          <div style="margin-top:10px"><input id="reg-email" class="form-control" placeholder="Email"></div>
          <div style="margin-top:10px"><input id="reg-phone" class="form-control" placeholder="Phone"></div>
          <div style="margin-top:10px"><input id="reg-country" class="form-control" placeholder="Country"></div>
          <div style="margin-top:10px"><input id="reg-password" type="password" class="form-control" placeholder="Password"></div>
          <div style="margin-top:12px">
            <button class="btn btn-primary" onclick="registerUser()">Create Account</button>
            <button class="btn btn-outline" onclick="showPage('landing-page')">Back</button>
          </div>
          <p class="small" style="margin-top:10px">A verification email will be sent. You can login before verifying but some features may be restricted.</p>
        </div>
      </section>

      <!-- Login -->
      <section id="login-page" class="page hidden">
        <div class="card" style="max-width:720px;margin:auto">
          <h2>Login</h2>
          <div style="margin-top:10px"><input id="login-email" class="form-control" placeholder="Email"></div>
          <div style="margin-top:10px"><input id="login-password" type="password" class="form-control" placeholder="Password"></div>
          <div style="margin-top:12px">
            <button class="btn btn-primary" onclick="loginUser()">Login</button>
            <button class="btn btn-outline" onclick="showPage('landing-page')">Back</button>
          </div>
        </div>
      </section>

      <!-- User Dashboard (placeholder -- your original UI will be used) -->
      <section id="user-dashboard" class="page hidden">
        <div class="card">
          <h2>Welcome, <span id="dash-name">User</span></h2>
          <div class="small" id="dash-kyc">KYC: -</div>
          <div style="margin-top:12px">
            <button class="btn btn-primary" onclick="openKYC()">Submit/View KYC</button>
            <button class="btn btn-outline" onclick="openTasks()">Tasks</button>
          </div>
        </div>
      </section>

      <!-- KYC page -->
      <section id="kyc-page" class="page hidden">
        <div class="card" style="max-width:720px;margin:auto">
          <h2>KYC Verification</h2>
          <div style="margin-top:10px"><input id="kyc-name" class="form-control" placeholder="Full name"></div>

          <div style="margin-top:10px">
            <label>ID front</label>
            <div class="file-upload" id="kyc-front-upload">Click to select
              <input id="kyc-front" type="file" accept="image/*" class="hidden">
            </div>
            <div class="small" id="kyc-front-name">No file chosen</div>
          </div>

          <div style="margin-top:10px">
            <label>ID back</label>
            <div class="file-upload" id="kyc-back-upload">Click to select
              <input id="kyc-back" type="file" accept="image/*" class="hidden">
            </div>
            <div class="small" id="kyc-back-name">No file chosen</div>
          </div>

          <div style="margin-top:10px">
            <label>Selfie with ID</label>
            <div class="file-upload" id="kyc-selfie-upload">Click to select
              <input id="kyc-selfie" type="file" accept="image/*" class="hidden">
            </div>
            <div class="small" id="kyc-selfie-name">No file chosen</div>
          </div>

          <div style="margin-top:12px">
            <button class="btn btn-primary" onclick="submitKYC()">Submit KYC</button>
            <button class="btn btn-outline" onclick="showPage('user-dashboard')">Back</button>
          </div>
        </div>
      </section>

      <!-- KYC pending page -->
      <section id="kyc-pending-page" class="page hidden">
        <div class="card" style="max-width:720px;margin:auto">
          <h2>KYC Pending</h2>
          <p class="small">Your KYC documents are under review. Admin will approve or reject shortly.</p>
        </div>
      </section>

      <!-- Admin dashboard -->
      <section id="admin-dashboard" class="page hidden">
        <div class="card">
          <h2>Admin Dashboard</h2>
          <div id="admin-stats" class="small">Loading admin stats...</div>
          <div id="admin-kyc-list" style="margin-top:12px"></div>
        </div>
      </section>
    </main>

    <footer>
      &copy; 2025 YSM. All rights reserved.
    </footer>
  </div>

  <!-- Modal placeholder -->
  <div id="modal" class="hidden card" style="position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);min-width:320px;z-index:10000"></div>

  <script>
  // ===================== Helpers & UI =====================
  function $(id){ return document.getElementById(id); }
  function showPage(pageId){
    // Hide all .page sections, then show the requested one
    document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
    const el = document.getElementById(pageId);
    if (el) {
      el.classList.remove('hidden');
      window.scrollTo(0,0);
    } else {
      console.warn('showPage: Page not found ->', pageId);
    }
  }

  function openModal(html){
    const m = $('modal'); if(!m) return;
    m.innerHTML = html; m.classList.remove('hidden');
  }
  function closeModal(){ const m = $('modal'); if(!m) return; m.classList.add('hidden'); m.innerHTML=''; }

  // Minimal user-facing messages (non-blocking)
  function showSuccess(msg){ console.info(msg); /* optionally toast */ }
  function showError(msg){ console.error(msg); alert(msg); }
  function showLoading(){ /* optional spinner */ }
  function hideLoading(){ /* hide spinner */ }

  // UI navigation helpers used inside pages
  function openKYC(){ showPage('kyc-page'); }
  function openTasks(){ openModal('<h3>Tasks</h3><p>Task list placeholder</p>'); }

  // ===================== Firebase setup =====================
  const firebaseConfig = {
    apiKey: "AIzaSyDOKJQayF5j5xCp6LVZEEFFJH0QiQtezgg",
    authDomain: "ysm-platform-6ef20.firebaseapp.com",
    projectId: "ysm-platform-6ef20",
    storageBucket: "ysm-platform-6ef20.appspot.com",
    messagingSenderId: "485407332553",
    appId: "1:485407332553:web:77bd1bf2b3146486e51518"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  const storage = firebase.storage();

  // App state
  let currentUser = null;
  let userId = null;
  let appReadyResolve;
  const appReady = new Promise(resolve => { appReadyResolve = resolve; });

  // ===================== Loader logic (adaptive) =====================
  const loaderWrap = $('loader-wrap');
  const loaderProgress = $('loader-progress');
  // Simulated progress state - grows towards readiness; grows faster if appReady resolves early
  let progress = 0;
  let progressInterval = null;

  function startAdaptiveLoader(){
    // Reset
    progress = 0;
    loaderProgress.style.left = '50%';
    loaderProgress.style.right = '50%';
    loaderProgress.style.width = '0%';
    loaderWrap.style.opacity = '1';
    loaderWrap.style.display = 'flex';

    // progress tick: grows slowly from center; if appReady resolves, we accelerate to 100
    progressInterval = setInterval(() => {
      // incremental growth (slower when small, faster when larger)
      if (progress < 60) progress += Math.random() * 2 + 0.6; // steady initial
      else progress += Math.random() * 4 + 1.2; // accelerate later
      updateLoaderVisual(progress);
      if (progress >= 99) {
        finishLoader();
      }
    }, 120);

    // If appReady resolves, speed to completion within ~700-1200ms
    appReady.then(() => {
      // accelerate to 100 smoothly
      const targetInc = () => {
        progress += 6 + Math.random()*8;
        updateLoaderVisual(progress);
        if (progress < 100) setTimeout(targetInc, 80);
        else finishLoader();
      };
      targetInc();
    });

    // Safety timeout: never stay more than 8 seconds
    setTimeout(() => { if (progress < 100) finishLoader(); }, 8000);
  }

  function updateLoaderVisual(p){
    const clamped = Math.min(100, Math.max(0, p));
    // We animate growth from center: left=50 - clamped/2%, right=50 - clamped/2%
    const half = (100 - clamped) / 2;
    loaderProgress.style.left = half + '%';
    loaderProgress.style.right = half + '%';
    // width is auto-calculated via left/right; set width 100% to ensure full fill when left=0,right=0
    loaderProgress.style.width = '100%';
  }

  function finishLoader(){
    if (progressInterval) { clearInterval(progressInterval); progressInterval = null; }
    // Fade out loader over 1.5s, then show app
    loaderWrap.style.opacity = '0';
    setTimeout(() => {
      loaderWrap.style.display = 'none';
      // Show app root (fade in)
      document.getElementById('app-root').style.opacity = '1';
      // Show default landing page (unless user is already signed in and will be routed)
      showPage('landing-page');
    }, 1500);
  }

  // Start loader immediately
  startAdaptiveLoader();

  // ===================== Auth & App logic =====================
  // registerUser: create user, create firestore doc, send email verification
  async function registerUser(){
    const name = $('reg-name')?.value?.trim();
    const email = $('reg-email')?.value?.trim();
    const phone = $('reg-phone')?.value?.trim();
    const country = $('reg-country')?.value?.trim();
    const password = $('reg-password')?.value;
    if (!name || !email || !phone || !country || !password) { showError('Please fill all fields'); return; }
    showLoading();
    try {
      const ucred = await auth.createUserWithEmailAndPassword(email, password);
      const u = ucred.user;
      if (!u) throw new Error('User creation failed');
      // Create user doc
      await db.collection('users').doc(u.uid).set({
        name, email, phone, country, tier:'unassigned', kycStatus:'unverified', role:'user', createdAt:new Date().toISOString()
      });
      // send verification email (best-effort)
      try { await u.sendEmailVerification(); showSuccess('Verification email sent.'); } catch(e){ console.warn('verification send failed:', e); }
      // Success message; auth state listener will handle UI
      showSuccess('Account created. Check your email for verification.');
      showPage('landing-page');
    } catch (err){
      console.error('Register error', err);
      showError('Registration failed: ' + (err.message || err));
    } finally { hideLoading(); }
  }

  // loginUser: sign in, allow login even if not verified but show banner
  async function loginUser(){
    const email = $('login-email')?.value?.trim();
    const password = $('login-password')?.value;
    if (!email || !password) { showError('Enter email & password.'); return; }
    showLoading();
    try {
      const cred = await auth.signInWithEmailAndPassword(email, password);
      const u = cred.user;
      if (u && !u.emailVerified) showSuccess('Logged in ‚Äî please verify your email. Some features may be restricted.');
      else showSuccess('Logged in successfully.');
    } catch (err){
      console.error('Login error', err);
      showError('Login failed: ' + (err.message || err));
    } finally { hideLoading(); }
  }

  function logout(){
    auth.signOut().then(()=>{ showSuccess('Logged out'); showPage('landing-page'); }).catch(err => { console.error('Logout error', err); showError('Logout failed'); });
  }

  // submitKYC: upload files and set kycStatus pending
  async function submitKYC(){
    const fullName = $('kyc-name')?.value?.trim();
    const frontInput = $('kyc-front');
    const backInput = $('kyc-back');
    const selfieInput = $('kyc-selfie');
    if (!currentUser || !currentUser.id) { showError('No authenticated user'); return; }
    if (!fullName || !frontInput?.files?.length || !backInput?.files?.length || !selfieInput?.files?.length) { showError('Please complete KYC and upload required files'); return; }
    showLoading();
    try {
      const uid = currentUser.id;
      // upload front
      const frontPath = `user_uploads/${uid}/kyc-front-${Date.now()}-${frontInput.files[0].name}`;
      const backPath = `user_uploads/${uid}/kyc-back-${Date.now()}-${backInput.files[0].name}`;
      const selfiePath = `user_uploads/${uid}/kyc-selfie-${Date.now()}-${selfieInput.files[0].name}`;
      const frontRef = storage.ref(frontPath);
      const backRef = storage.ref(backPath);
      const selfieRef = storage.ref(selfiePath);
      await frontRef.put(frontInput.files[0]);
      await backRef.put(backInput.files[0]);
      await selfieRef.put(selfieInput.files[0]);
      const frontUrl = await frontRef.getDownloadURL();
      const backUrl = await backRef.getDownloadURL();
      const selfieUrl = await selfieRef.getDownloadURL();
      await db.collection('users').doc(uid).update({
        kycStatus: 'pending',
        kyc: { fullName, frontUrl, backUrl, selfieUrl, submittedAt: new Date().toISOString() }
      });
      showSuccess('KYC submitted ‚Äî pending admin review.');
      showPage('kyc-pending-page');
    } catch (err) {
      console.error('KYC submit error', err);
      showError('Failed to submit KYC: ' + (err.message || err));
    } finally { hideLoading(); }
  }

  // loadAdminPanel: basic admin listing
  async function loadAdminPanel(){
    showPage('admin-dashboard');
    const statsEl = $('admin-stats'); const listEl = $('admin-kyc-list');
    if (statsEl) statsEl.textContent = 'Loading...';
    if (listEl) listEl.textContent = 'Loading...';
    try {
      const all = await db.collection('users').get();
      const pending = await db.collection('users').where('kycStatus','==','pending').get();
      if (statsEl) statsEl.innerHTML = `Total users: <strong>${all.size}</strong><br>Pending KYC: <strong>${pending.size}</strong>`;
      if (listEl) {
        if (pending.size === 0) listEl.textContent = 'No pending KYC.';
        else {
          let html=''; pending.forEach(doc => {
            const d=doc.data();
            html += `<div style="padding:8px;border-bottom:1px solid rgba(255,255,255,0.04)"><strong>${d.name||d.email}</strong><div class="small">Submitted: ${d.kyc?.submittedAt||'N/A'}</div><div style="margin-top:6px"><button class="btn btn-primary" data-uid="${doc.id}" data-action="approve">Approve</button> <button class="btn btn-outline" data-uid="${doc.id}" data-action="reject">Reject</button></div></div>`;
          });
          listEl.innerHTML = html;
          listEl.querySelectorAll('button').forEach(btn => {
            btn.addEventListener('click', async (ev) => {
              const uid = ev.target.getAttribute('data-uid');
              const action = ev.target.getAttribute('data-action');
              try {
                await db.collection('users').doc(uid).update({ kycStatus: action === 'approve' ? 'approved' : 'rejected' });
                alert('KYC ' + (action==='approve'?'approved':'rejected') + ' for ' + uid);
                loadAdminPanel();
              } catch(e) { console.error(e); alert('Failed to update'); }
            });
          });
        }
      }
    } catch (err) {
      console.error('Admin load error', err);
      if (statsEl) statsEl.textContent = 'Failed to load: ' + (err.message||err);
    }
  }

  // ===================== Auth state listener =====================
  auth.onAuthStateChanged(async (u) => {
    try {
      if (u) {
        userId = u.uid;
        // ensure user doc
        const ref = db.collection('users').doc(userId);
        const doc = await ref.get();
        if (!doc.exists) {
          await ref.set({ name: u.displayName||'', email: u.email||'', tier:'unassigned', kycStatus:'unverified', role:'user', createdAt:new Date().toISOString() });
        }
        const fresh = await ref.get();
        const data = fresh.exists ? fresh.data() : {};
        currentUser = { id: userId, name: data.name || u.displayName || (u.email||'').split('@')[0], email: data.email || u.email || '', tier: data.tier || 'unassigned', kycStatus: data.kycStatus || 'unverified', role: data.role || 'user', raw: data };
        // Update UI small bits
        if (currentUser) {
          // set dashboard UI
          const dn = $('dash-name'); if (dn) dn.textContent = currentUser.name;
          const dk = $('dash-kyc'); if (dk) dk.textContent = 'KYC: ' + (currentUser.kycStatus || 'unverified');
        }
        // route user
        if (currentUser.role === 'admin') {
          // resolve loader readiness
          appReadyResolve && appReadyResolve();
          loadAdminPanel();
        } else {
          // normal user
          appReadyResolve && appReadyResolve();
          if (currentUser.kycStatus === 'approved') showPage('user-dashboard');
          else if (currentUser.kycStatus === 'pending') showPage('kyc-pending-page');
          else showPage('kyc-page');
        }
      } else {
        // not signed in
        currentUser = null; userId = null;
        appReadyResolve && appReadyResolve();
        // default landing. showPage will be called by loader finish
      }
    } catch (err) {
      console.error('Error loading user data:', err);
      showError('Error loading user data: ' + (err.message || err));
      appReadyResolve && appReadyResolve();
    }
  });

  // Wire file input click helpers (safe guards)
  document.addEventListener('click', (e) => {
    if (e.target && e.target.id === 'kyc-front-upload') $('kyc-front')?.click();
    if (e.target && e.target.id === 'kyc-back-upload') $('kyc-back')?.click();
    if (e.target && e.target.id === 'kyc-selfie-upload') $('kyc-selfie')?.click();
  });

  // Update file labels
  ['kyc-front','kyc-back','kyc-selfie'].forEach(id => {
    const el = $(id);
    if (el) {
      el.addEventListener('change', () => {
        const name = el.files[0] ? el.files[0].name : 'No file chosen';
        $(id + '-name') && ($(id + '-name').textContent = name);
      });
    }
  });

  // Expose some functions to window for debugging
  window.showPage = showPage;
  window.registerUser = registerUser;
  window.loginUser = loginUser;
  window.logout = logout;
  window.submitKYC = submitKYC;
  window.loadAdminPanel = loadAdminPanel;

  // If loader hasn't already been resolved by auth state, resolve after 3s to allow adaptive finish
  setTimeout(()=>{ appReadyResolve && appReadyResolve(); }, 3000);

  </script>
</body>
</html>
