<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>YSM - School Simulation (Points System)</title>

  <!-- icons -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

  <!-- Firebase compat libs (already included in your snippet) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-storage-compat.js"></script>

  <style>
    /* Simple, clear styling so the demo looks decent */
    :root{--bg:#0f1724;--card:#0b1320;--muted:#9aa6b2;--accent:#2dd4bf;--danger:#ef4444;--warning:#f59e0b}
    *{box-sizing:border-box}
    body{
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      margin:0;
      min-height:100vh;
      background:linear-gradient(180deg,#071024 0%, #0b1320 100%);
      color:#e6eef6;
      padding:20px;
    }
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
    h1{margin:0;font-size:20px}
    .container{max-width:1100px;margin:0 auto;background:rgba(255,255,255,0.02);padding:20px;border-radius:12px}
    .grid{display:grid;gap:16px}
    .cols-2{grid-template-columns:1fr 320px}
    .cols-3{grid-template-columns:1fr 1fr 1fr}
    .card{background:rgba(255,255,255,0.02);padding:16px;border-radius:10px;box-shadow:0 6px 18px rgba(2,6,23,0.6)}
    .muted{color:var(--muted);font-size:13px}
    input,select,button,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit}
    button{cursor:pointer}
    .btn{background:var(--accent);color:#002; border:none;padding:10px 12px;border-radius:8px;font-weight:600}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06)}
    .btn-danger{background:var(--danger);color:white}
    .btn-warning{background:var(--warning);color:white}
    .small{font-size:13px;padding:6px 8px}
    .page{display:none}
    .topbar{display:flex;gap:8px;align-items:center}
    .right{display:flex;gap:8px;align-items:center}
    .loading{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:#06202a;padding:18px;border-radius:10px;display:none;box-shadow:0 8px 30px rgba(0,0,0,0.6)}
    .admin-access{position:fixed;right:10px;bottom:10px;background:transparent;border:none;opacity:0.02;padding:10px;cursor:pointer}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.03)}
    .pill{display:inline-block;padding:6px 8px;border-radius:999px;background:rgba(255,255,255,0.03);font-size:12px}
    .danger{background:rgba(255,0,0,0.06);color:var(--danger)}
    .success{background:rgba(0,255,128,0.06);color:#7fffd4}
    .warning{background:rgba(245,158,11,0.06);color:var(--warning)}
    .flex{display:flex;gap:8px;align-items:center}
    footer{margin-top:20px;color:var(--muted);font-size:13px;text-align:center}
    .video-container{position:relative;padding-bottom:56.25%;height:0;overflow:hidden;border-radius:8px;margin:10px 0}
    .video-container iframe{position:absolute;top:0;left:0;width:100%;height:100%}
    .banned{color:var(--danger);font-weight:bold}
    .modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:none;justify-content:center;align-items:center;z-index:1000}
    .modal-content{background:var(--card);padding:20px;border-radius:10px;max-width:500px;width:90%}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}
    .modal-close{background:none;border:none;color:var(--muted);font-size:20px;cursor:pointer}
    .tier-table{width:100%;margin:15px 0}
    .tier-table th{background:rgba(255,255,255,0.05)}
    @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <header class="container">
    <div>
      <h1>YSM — School Simulation (Points System)</h1>
      <div class="muted">Demo only — simulated points, simulated withdrawals. Not connected to YouTube/Netflix.</div>
    </div>
    <div class="topbar right">
      <div id="top-user-info" class="muted"></div>
      <button id="btn-logout" class="btn" style="display:none" onclick="logout()">Logout</button>
      <button id="btn-admin" class="btn-ghost small" onclick="showPage('admin-login-page')">Admin</button>
    </div>
  </header>

  <main class="container">
    <!-- Loading -->
    <div class="loading" id="loading">
      <div style="display:flex;gap:10px;align-items:center">
        <div class="spinner" style="width:28px;height:28px;border-radius:50%;border:4px solid rgba(255,255,255,0.06);border-top-color:var(--accent);animation:spin 1s linear infinite"></div>
        <div>Processing...</div>
      </div>
    </div>

    <button class="admin-access" title="Admin Access (hidden)" onclick="showPage('admin-login-page')"></button>

    <!-- PAGES -->
    <div id="landing-page" class="page card">
      <h2>Welcome</h2>
      <p class="muted">Use this demo to explore user/admin flows. Registration creates a user with a starter tier and points.</p>

      <div class="grid cols-2" style="margin-top:16px">
        <div class="card">
          <h3>Register</h3>
          <label class="muted">Name</label>
          <input id="reg-name" placeholder="Full name">
          <label class="muted">Email</label>
          <input id="reg-email" placeholder="name@example.com" type="email">
          <label class="muted">Phone</label>
          <input id="reg-phone" placeholder="+2547...">
          <label class="muted">Country</label>
          <input id="reg-country" placeholder="Kenya">
          <label class="muted">Password</label>
          <input id="reg-password" type="password" placeholder="password">
          <div style="margin-top:10px;display:flex;gap:8px">
            <button class="btn" onclick="registerUser()">Register</button>
            <button class="btn-ghost" onclick="document.getElementById('landing-login-form').style.display='block'">I already have an account</button>
          </div>
        </div>

        <div class="card" id="landing-login-form" style="display:block">
          <h3>Login</h3>
          <label class="muted">Email</label>
          <input id="login-email" placeholder="name@example.com">
          <label class="muted">Password</label>
          <input id="login-password" type="password" placeholder="password">
          <div style="margin-top:10px;display:flex;gap:8px">
            <button class="btn" onclick="loginUser()">Login</button>
            <button class="btn-ghost" onclick="showPage('kyc-page')">Complete KYC</button>
          </div>
          <p class="muted" style="margin-top:8px">Admin account for demo: username <code>admin</code> / password <code>admin123</code></p>
        </div>
      </div>
    </div>

    <!-- KYC Page -->
    <div id="kyc-page" class="page card">
      <h2>KYC — Identity Verification (Simulated)</h2>
      <p class="muted">This demo stores simulated image URLs. In production replace with real storage & verification workflow.</p>

      <label class="muted">Full name</label>
      <input id="kyc-name">

      <label class="muted">ID Type</label>
      <select id="kyc-id-type">
        <option value="">-- Select ID type --</option>
        <option value="national_id">National ID</option>
        <option value="passport">Passport</option>
        <option value="driver_license">Driver license</option>
      </select>

      <label class="muted">ID Number</label>
      <input id="kyc-id-number">

      <div style="margin-top:10px;display:flex;gap:8px">
        <button class="btn" onclick="submitKYC()">Submit KYC (Simulated)</button>
        <button class="btn-ghost" onclick="showPage('landing-page')">Back</button>
      </div>
    </div>

    <!-- KYC pending -->
    <div id="kyc-pending-page" class="page card">
      <h2>KYC Submitted</h2>
      <p class="muted">Your documents are under review. Admin will approve or reject.</p>
      <div style="margin-top:10px">
        <button class="btn" onclick="showPage('landing-page')">Return</button>
      </div>
    </div>

    <!-- User Dashboard -->
    <div id="user-dashboard" class="page card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <h2 id="user-name">User</h2>
          <div class="muted" id="user-email"></div>
        </div>
        <div style="text-align:right">
          <div class="muted">Tier: <span id="user-tier" class="pill">115.38</span></div>
          <div class="muted">Points: <strong id="user-balance">$0.00</strong></div>
          <div class="muted">Ads watched today: <span id="user-daily-count">0</span>/<span id="user-daily-limit">0</span></div>
        </div>
      </div>

      <hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,0.03)">

      <div class="grid cols-2">
        <div class="card">
          <h3>Watch simulated ad</h3>
          <p class="muted">Click to simulate watching an ad and earn points (school demo).</p>
          <div style="display:flex;gap:8px;align-items:center">
            <button class="btn" onclick="watchAd()">Watch Ad (Simulate)</button>
            <button class="btn-ghost" onclick="simulateMultipleAds()">Auto 5x</button>
          </div>
          <div id="video-container" class="video-container" style="display:none">
            <!-- YouTube video will be embedded here -->
          </div>
        </div>

        <div class="card">
          <h3>Withdraw (Simulated)</h3>
          <label class="muted">Amount (points)</label>
          <input id="withdraw-amount" placeholder="e.g. 5">
          <label class="muted">Method</label>
          <select id="withdraw-method">
            <option value="">Select method</option>
            <option value="mpesa">M-Pesa (simulated)</option>
            <option value="bank">Bank Transfer (simulated)</option>
            <option value="paypal">PayPal (simulated)</option>
          </select>
          <div style="margin-top:8px;display:flex;gap:8px">
            <button class="btn" onclick="requestWithdrawal()">Request Withdrawal (Simulated)</button>
            <button class="btn-ghost" onclick="showPage('landing-page')">Back</button>
          </div>
        </div>
      </div>

      <div style="margin-top:16px" class="card">
        <h3>Account activity (simulated)</h3>
        <table id="activity-table">
          <thead><tr><th>Time</th><th>Action</th><th>Amount</th></tr></thead>
          <tbody id="activity-body"><tr><td colspan="3" class="muted">No activity yet</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- Admin Login -->
    <div id="admin-login-page" class="page card">
      <h2>Admin Login (Demo)</h2>
      <p class="muted">Use the demo admin or sign in with admin@ysm.com / admin123 if created in your Firebase.</p>
      <label class="muted">Username</label>
      <input id="admin-username" placeholder="admin">
      <label class="muted">Password</label>
      <input id="admin-password" type="password" placeholder="admin123">
      <div style="margin-top:12px;display:flex;gap:8px">
        <button class="btn" onclick="loginAdmin()">Admin Login</button>
        <button class="btn-ghost" onclick="showPage('landing-page')">Back</button>
      </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="admin-dashboard" class="page card">
      <h2>Admin Dashboard</h2>
      <div style="display:flex;gap:12px;align-items:center;margin-bottom:12px;flex-wrap:wrap">
        <button class="btn-ghost" onclick="showAdminSection('admin-stats')">Stats</button>
        <button class="btn-ghost" onclick="showAdminSection('admin-kyc')">KYC</button>
        <button class="btn-ghost" onclick="showAdminSection('admin-withdrawals')">Withdrawals</button>
        <button class="btn-ghost" onclick="showAdminSection('admin-users')">Users</button>
        <button class="btn-ghost" onclick="showAdminSection('admin-videos')">Videos</button>
        <button class="btn-ghost" onclick="showAdminSection('admin-tiers')">Tiers</button>
        <button class="btn-ghost" onclick="showAdminSection('admin-reset')">Daily Reset</button>
      </div>

      <div id="admin-stats" class="admin-section card">
        <h3>Overview</h3>
        <div style="display:flex;gap:12px;flex-wrap:wrap">
          <div class="card" style="min-width:160px"><div class="muted">Total users</div><div id="total-users" style="font-size:20px">0</div></div>
          <div class="card" style="min-width:160px"><div class="muted">Pending KYC</div><div id="pending-kyc" style="font-size:20px">0</div></div>
          <div class="card" style="min-width:160px"><div class="muted">Pending withdrawals</div><div id="pending-withdrawals" style="font-size:20px">0</div></div>
          <div class="card" style="min-width:200px"><div class="muted">Total earnings (simulated)</div><div id="total-earnings">$0.00</div></div>
          <div class="card" style="min-width:200px"><div class="muted">Total processed (simulated)</div><div id="total-withdrawals">$0.00</div></div>
        </div>
      </div>

      <div id="admin-kyc" class="admin-section card" style="display:none">
        <h3>Pending KYC Submissions</h3>
        <table>
          <thead><tr><th>User</th><th>ID Type</th><th>ID Number</th><th>Submitted</th><th>Action</th></tr></thead>
          <tbody id="kyc-list-body"><tr><td colspan="5" class="muted">No pending KYC</td></tr></tbody>
        </table>
      </div>

      <div id="admin-withdrawals" class="admin-section card" style="display:none">
        <h3>Pending Withdrawals</h3>
        <table>
          <thead><tr><th>User</th><th>Amount</th><th>Method</th><th>Requested</th><th>Action</th></tr></thead>
          <tbody id="withdrawals-list-body"><tr><td colspan="5" class="muted">No pending withdrawals</td></tr></tbody>
        </table>
      </div>

      <div id="admin-users" class="admin-section card" style="display:none">
        <h3>All Users</h3>
        <div class="flex" style="margin-bottom:10px">
          <input type="text" id="user-search" placeholder="Search users..." style="flex:1">
          <button class="btn-ghost small" onclick="searchUsers()">Search</button>
        </div>
        <table>
          <thead><tr><th>Name</th><th>Email</th><th>Tier</th><th>Points</th><th>KYC</th><th>Status</th><th>Actions</th></tr></thead>
          <tbody id="users-list-body"><tr><td colspan="7" class="muted">No users</td></tr></tbody>
        </table>
      </div>

      <div id="admin-videos" class="admin-section card" style="display:none">
        <h3>Manage Videos</h3>
        <div class="card">
          <h4>Add New Video</h4>
          <label class="muted">YouTube Video ID</label>
          <input id="video-id" placeholder="e.g., dQw4w9WgXcQ">
          <label class="muted">Video Title</label>
          <input id="video-title" placeholder="Video title">
          <label class="muted">Duration (seconds)</label>
          <input id="video-duration" type="number" placeholder="e.g., 120">
          <div style="margin-top:10px">
            <button class="btn" onclick="addVideo()">Add Video</button>
          </div>
        </div>
        <div style="margin-top:15px">
          <h4>Available Videos</h4>
          <table>
            <thead><tr><th>Title</th><th>Duration</th><th>Actions</th></tr></thead>
            <tbody id="videos-list-body"><tr><td colspan="3" class="muted">No videos added</td></tr></tbody>
          </table>
        </div>
      </div>

      <div id="admin-tiers" class="admin-section card" style="display:none">
        <h3>Manage Tiers</h3>
        <div class="card">
          <h4>Tier System</h4>
          <table class="tier-table">
            <thead>
              <tr>
                <th>Tier Name</th>
                <th>Ads Per Day</th>
                <th>Pay Per Ad</th>
                <th>Daily Earnings</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="tiers-list-body">
              <!-- Tiers will be populated here -->
            </tbody>
          </table>
        </div>
        <div class="card" style="margin-top:15px">
          <h4>Assign Tier to User</h4>
          <label class="muted">Select User</label>
          <select id="user-select">
            <option value="">-- Select User --</option>
          </select>
          <label class="muted">Select Tier</label>
          <select id="tier-select">
            <option value="">-- Select Tier --</option>
          </select>
          <div style="margin-top:10px">
            <button class="btn" onclick="assignTierToUser()">Assign Tier</button>
          </div>
        </div>
      </div>

      <div id="admin-reset" class="admin-section card" style="display:none">
        <h3>Daily Reset Management</h3>
        <div class="card">
          <h4>Manual Daily Reset</h4>
          <p class="muted">This will reset all users' daily watch counts. This normally happens automatically at midnight.</p>
          <div style="margin-top:10px">
            <button class="btn-warning" onclick="manualDailyReset()">Perform Daily Reset Now</button>
          </div>
        </div>
        <div class="card" style="margin-top:15px">
          <h4>Reset Settings</h4>
          <label class="muted">Reset Time (24-hour format)</label>
          <input id="reset-time" type="time" value="00:00">
          <div style="margin-top:10px">
            <button class="btn" onclick="updateResetTime()">Update Reset Time</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modals -->
    <div id="user-details-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>User Details</h3>
          <button class="modal-close" onclick="closeModal('user-details-modal')">&times;</button>
        </div>
        <div id="user-details-content">
          <!-- User details will be populated here -->
        </div>
      </div>
    </div>

    <footer class="muted">This is a simulated school project — points and withdrawals are for demo only.</footer>
  </main>

  <script>
    // ==================== FIREBASE CONFIGURATION (kept from your original snippet) ====================
    const firebaseConfig = {
        apiKey: "AIzaSyDOKJQayF5j5xCp6LVZEEFFJH0QiQtezgg",
        authDomain: "ysm-platform-6ef20.firebaseapp.com",
        projectId: "ysm-platform-6ef20",
        storageBucket: "ysm-platform-6ef20.firebasestorage.app",
        messagingSenderId: "485407332553",
        appId: "1:485407332553:web:77bd1bf2b3146486e51518"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const storage = firebase.storage();

    // APP STATE
    let currentUser = null;
    let userId = null;
    const ADMIN_UID = 'OK1OugEkINVckgUbsz4I8SPBGrz2'; // keep for reference; for demo we check email too

    // Tier system with more tiers
    const tierSystem = {
        "115.38": { adsPerDay: 8, payPerAd: 0.48, daily: 3.85 },
        "192.31": { adsPerDay: 10, payPerAd: 0.64, daily: 6.41 },
        "269.23": { adsPerDay: 12, payPerAd: 0.80, daily: 9.62 },
        "346.15": { adsPerDay: 15, payPerAd: 0.96, daily: 14.42 },
        "500.00": { adsPerDay: 20, payPerAd: 1.20, daily: 24.00 }
    };

    // Page setup
    function showPage(pageId) {
      console.log('Navigating to', pageId);
      document.querySelectorAll('.page').forEach(p => p.style.display = 'none');
      document.getElementById(pageId).style.display = 'block';
      // update t
